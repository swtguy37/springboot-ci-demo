pipeline {
    agent any

    tools {
        maven 'Maven'
        jdk 'Java'
    }

    stages {

        stage('Clean Workspace') {
            steps {
                deleteDir()
                checkout scm
            }
        }

        stage('Parallel Builds') {
            parallel {

                stage('Build & Deploy Demo Project') {
                    steps {
                        dir('demo') {
                            echo 'Building demo project...'
                            bat 'mvn clean package'

                            bat '''
                            netstat -ano | findstr :8082 > pid.txt

                            for /f "tokens=5" %%a in (pid.txt) do (
                                echo Killing process %%a
                                taskkill /PID %%a /F
                            )

                            del pid.txt
                            echo Starting application...
                            start java -jar target\\*.jar
                            '''
                        }
                    }
                }

                stage('Build Examples Project') {
                    steps {
                        dir('examples') {
                            echo 'Building examples project...'
                            bat 'mvn clean install'
                        }
                    }
                }

                stage('Build Product Project') {
                    steps {
                        dir('product') {
                            echo 'Building product project...'
                            bat 'mvn clean package'
                        }
                    }
                }
            }
        }

        stage('Final Message') {
            steps {
                echo 'All projects built successfully! ✅'
            }
        }
    }

    post {
        success {
            archiveArtifacts artifacts: '**/target/*.jar', fingerprint: true
            echo 'Artifacts Archived ✅'
        }
        failure {
            echo 'Pipeline finished RED ❌'
        }
    }
}
